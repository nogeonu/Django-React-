# 병리 이미지 분석 시스템 워크플로우

## 📋 시스템 개요

**목적**: 병리 조직 슬라이드 이미지(WSI)를 업로드하고 AI 모델(CLAM)을 통해 종양 여부를 자동 분류하는 시스템

**핵심 기술**:
- **CLAM (Attention MIL)**: Multiple Instance Learning 기반 병리 이미지 분류
- **H-optimus-0**: Bioptimus의 병리 이미지 특화 Feature Extractor
- **OpenSlide**: WSI 파일 처리
- **Orthanc PACS**: 의료 영상 저장 및 관리
- **Mosec**: 딥러닝 모델 서빙 프레임워크

---

## 🔄 전체 워크플로우

### 1️⃣ 병리 이미지 업로드 단계

```
사용자 (방사선과)
    ↓
영상 업로드 페이지 접속
    ↓
영상 유형: "병리 영상" 선택
    ↓
환자 선택 (기존 환자 또는 신규)
    ↓
SVS 파일 업로드 (드래그 앤 드롭 또는 파일 선택)
    ↓
Django API (/api/mri/pathology/upload/)
    ↓
SVS → DICOM 변환
    ├─ OpenSlide로 SVS 파일 읽기
    ├─ 512x512 RGB 컬러 썸네일 생성
    ├─ DICOM 메타데이터 생성
    │   ├─ Modality: SM (Slide Microscopy)
    │   ├─ 환자 정보 (PatientID, PatientName)
    │   ├─ 스터디 정보 (StudyDate, StudyDescription)
    │   ├─ PhotometricInterpretation: RGB
    │   └─ 원본 WSI 크기 정보
    └─ DICOM 파일 생성
    ↓
Orthanc PACS에 저장
    ↓
업로드 완료 응답
    ↓
프론트엔드에 병리 이미지 목록 표시 (컬러)
```

---

### 2️⃣ 병리 이미지 AI 분석 단계

```
사용자 (영상의학과/외과)
    ↓
영상 판독 페이지 접속
    ↓
영상 유형: "병리 영상" 선택
    ↓
환자 선택
    ↓
병리 이미지 목록 확인 (Modality=SM 필터링)
    ↓
이미지 선택 → "AI 분석" 버튼 클릭
    ↓
프론트엔드 (MRIImageDetail.tsx)
    ├─ instance_id 추출
    └─ /api/mri/pathology/analyze/ POST 요청
    ↓
Django API (pathology_views.py)
    ├─ instance_id 수신
    ├─ Orthanc API 호출
    │   └─ /instances/{instance_id}/file
    ├─ DICOM 파일 다운로드
    ├─ Base64 인코딩
    └─ Mosec 서비스 호출 (포트 5008)
    ↓
Mosec 병리 서비스 (pathology_mosec.py)
    ├─ Base64 디코딩 → SVS 바이트
    ├─ 임시 파일로 저장
    ├─ OpenSlide로 WSI 열기
    ├─ 패치 추출 (최대 1000개, 224x224)
    │   ├─ 그리드 샘플링 (50% 오버랩)
    │   └─ 배경 필터링 (흰색 영역 제외)
    ├─ Feature 추출 (H-optimus-0)
    │   └─ 각 패치 → 1536차원 feature vector
    ├─ CLAM 모델 추론
    │   ├─ Attention MIL
    │   ├─ 패치별 attention weight 계산
    │   └─ 전체 슬라이드 분류
    └─ 결과 생성
        ├─ 클래스: Normal (0) / Tumor (1)
        ├─ 신뢰도 (Confidence)
        ├─ 클래스별 확률
        ├─ 사용된 패치 개수
        └─ Top 5 attention 패치 인덱스
    ↓
Django API로 결과 반환
    ↓
프론트엔드에 결과 표시
    ├─ 분류 결과 (정상/종양)
    ├─ 신뢰도 (%)
    ├─ 클래스별 확률 바 차트
    ├─ 분석 패치 개수
    └─ 주요 관심 영역 (Top attention patches)
```

---

## 🏗️ 시스템 아키텍처

### 서버 구성

```
GCP VM Instance (34.42.223.43)
├─ Nginx (포트 80/443)
│   └─ 프론트엔드 정적 파일 서빙
│
├─ Django (Gunicorn, 포트 8000)
│   ├─ REST API 엔드포인트
│   ├─ Orthanc 연동
│   └─ Mosec 서비스 호출
│
├─ Orthanc PACS (포트 8042)
│   ├─ DICOM 파일 저장 (RGB 컬러)
│   └─ 의료 영상 관리
│
└─ AI 서비스 (Mosec)
    ├─ ML Service (포트 5002) - 폐암 예측
    ├─ MRI Segmentation (포트 5006) - MRI 종양 세그멘테이션
    ├─ Mammography (포트 5007) - 유방촬영술 분류
    └─ Pathology (포트 5008) - 병리 이미지 분류 ✨
```

### 데이터 흐름 비교

| 단계 | MRI 세그멘테이션 | 맘모그래피 분류 | 병리 이미지 분류 |
|------|------------------|-----------------|------------------|
| **입력** | instance_ids (4개) | instance_ids (4개) | instance_id (1개) |
| **Django 역할** | instance_ids 전달 | instance_ids 전달 | DICOM 다운로드 + Base64 인코딩 |
| **Mosec 다운로드** | Orthanc에서 직접 | Orthanc에서 직접 | Django가 전달 (Base64) |
| **처리 시간** | 약 2분 | 약 10초 | 약 1-2분 |
| **출력** | 세그멘테이션 마스크 | 4개 분류 결과 + Grad-CAM | 2-class 분류 + Attention |

**병리 이미지만 Django가 다운로드하는 이유**:
- SVS 파일은 DICOM으로 변환되어 저장되므로, Mosec이 직접 읽을 수 없음
- Django에서 DICOM을 다운로드하여 원본 바이트를 Mosec에 전달
- Mosec은 이를 SVS로 처리 (OpenSlide 사용)

---

## 📊 주요 API 엔드포인트

### 병리 이미지 업로드
```http
POST /api/mri/pathology/upload/
Content-Type: multipart/form-data

Request:
- file: SVS 파일
- patient_id: 환자 ID
- patient_name: 환자 이름
- study_description: 검사 설명 (선택)

Response:
{
  "success": true,
  "patient_id": "P2025022",
  "orthanc_patient_id": "abc123...",
  "study_id": "def456...",
  "series_id": "ghi789...",
  "instance_id": "jkl012...",
  "file_name": "TCGA-BH-A1F6.svs"
}
```

### 병리 이미지 목록 조회
```http
GET /api/mri/pathology/images/?patient_id=P2025022

Response:
{
  "success": true,
  "total": 1,
  "images": [
    {
      "patient_id": "P2025022",
      "patient_name": "홍길동",
      "orthanc_patient_id": "abc123...",
      "study_id": "def456...",
      "series_id": "ghi789...",
      "instance_id": "jkl012...",
      "study_date": "20260112",
      "study_description": "Pathology WSI",
      "series_description": "Pathology WSI - TCGA-BH-A1F6.svs"
    }
  ]
}
```

### 병리 이미지 AI 분석
```http
POST /api/mri/pathology/analyze/
Content-Type: application/json

Request:
{
  "instance_id": "jkl012..."
}

Response:
{
  "success": true,
  "class_id": 1,
  "class_name": "Tumor",
  "confidence": 0.9234,
  "probabilities": {
    "Normal": 0.0766,
    "Tumor": 0.9234
  },
  "num_patches": 856,
  "top_attention_patches": [123, 456, 789, 234, 567]
}
```

### 서비스 헬스 체크
```http
GET /api/mri/pathology/health/

Response:
{
  "status": "healthy",
  "mosec_status_code": 200
}
```

---

## 🔬 CLAM 모델 상세

### 모델 구조

```python
AttentionMIL(
  input_dim=1536,      # H-optimus-0 feature 차원
  hidden_dim=512,      # Hidden layer 차원
  n_classes=2          # Normal / Tumor
)

구성:
├─ Feature Extractor (Linear + ReLU + Dropout)
│   └─ 1536 → 512
├─ Attention Module (Linear + Tanh + Linear)
│   └─ 512 → 256 → 1
└─ Classifier (Linear)
    └─ 512 → 2
```

### 추론 프로세스

1. **패치 추출**: WSI → N개의 224x224 패치 (최대 1000개)
   - 그리드 샘플링 (50% 오버랩)
   - 배경 필터링 (평균 픽셀값 > 220인 패치 제외)

2. **Feature 추출**: 각 패치 → H-optimus-0 → 1536차원 벡터
   - Bioptimus의 병리 이미지 특화 모델
   - Vision Transformer 기반

3. **Attention 계산**: 각 패치의 중요도 계산
   - Attention weight: softmax(tanh(Linear(features)))
   - 중요한 패치에 높은 가중치 부여

4. **Aggregation**: Attention-weighted sum of features
   - M = Σ(attention_i × feature_i)

5. **분류**: 최종 feature → 2-class 분류
   - Logits → Softmax → 확률
   - Argmax → 최종 클래스

### 성능 특징

- **입력**: Whole Slide Image (WSI) - SVS 형식
- **처리 시간**: 약 1-2분 (패치 개수에 따라)
- **메모리**: 약 700MB (CPU 모드)
- **정확도**: TCGA-BRCA 데이터셋 기준 학습
- **디바이스**: CPU (현재), GPU 가능

---

## 🎯 현재 구현 상태

### ✅ 완료된 기능

1. **병리 이미지 업로드**
   - ✅ SVS 파일 → RGB 컬러 DICOM 변환
   - ✅ Orthanc PACS 저장
   - ✅ 환자 이름 정확하게 표시
   - ✅ 메타데이터 관리

2. **병리 이미지 AI 분석**
   - ✅ CLAM 모델 배포 (Mosec, 포트 5008)
   - ✅ H-optimus-0 Feature Extractor
   - ✅ 2-class 분류 (Normal/Tumor)
   - ✅ instance_id 기반 분석 (MRI/맘모그래피와 동일)
   - ✅ Attention weight 계산

3. **프론트엔드 UI**
   - ✅ 영상 유형 선택 (병리 영상)
   - ✅ SVS 파일 업로드
   - ✅ 드래그 앤 드롭 지원
   - ✅ 병리 이미지 필터링 (Modality=SM)
   - ✅ AI 분석 버튼 및 결과 표시
   - ✅ 분류 결과 시각화
     - 정상/종양 배지
     - 신뢰도 표시
     - 클래스별 확률 바 차트
     - 분석 패치 개수
     - 주요 관심 영역 (Top attention patches)

4. **시스템 통합**
   - ✅ Django REST API
   - ✅ Orthanc 연동
   - ✅ Mosec 서비스 통합
   - ✅ Systemd 서비스 관리
   - ✅ GitHub Actions 자동 배포

### 🚧 향후 개선 사항

1. **프론트엔드 UI 개선**
   - [ ] 병리 이미지 전용 뷰어 추가 (확대/축소)
   - [ ] Attention map 히트맵 오버레이
   - [ ] Top attention 패치 시각화
   - [ ] 패치별 attention weight 표시

2. **성능 최적화**
   - [ ] 패치 추출 병렬화
   - [ ] Feature 캐싱
   - [ ] GPU 가속 (현재 CPU)
   - [ ] 배치 처리 최적화

3. **기능 확장**
   - [ ] 다중 클래스 분류 (종양 서브타입)
   - [ ] 패치별 attention 시각화
   - [ ] 보고서 생성 기능
   - [ ] 히스토리 추적

4. **모델 개선**
   - [ ] 더 많은 데이터로 재학습
   - [ ] 앙상블 모델
   - [ ] 불확실성 추정

---

## 📝 사용 시나리오

### 시나리오 1: 신규 환자 병리 이미지 업로드

```
1. 방사선과 직원이 시스템 접속
2. "영상 업로드" 메뉴 선택
3. 영상 유형: "병리 영상" 선택
4. 환자 정보 입력 (신규 환자)
   - 환자 ID: P2025022
   - 환자 이름: 홍길동
5. SVS 파일 드래그 앤 드롭
   - TCGA-BH-A1F6.svs
6. 업로드 완료 → Orthanc에 RGB 컬러로 저장됨
7. 확인: 환자 이름 "홍길동"으로 정확하게 표시
```

### 시나리오 2: 병리 이미지 AI 분석

```
1. 영상의학과 의사가 시스템 접속
2. "영상 판독" 메뉴 선택
3. 영상 유형: "병리 영상" 선택
4. 환자 검색 및 선택: 홍길동 (P2025022)
5. 병리 이미지 목록 확인
   - TCGA-BH-A1F6.svs (컬러 이미지)
6. 이미지 선택 → "AI 분석" 버튼 클릭
7. 분석 진행 중... (약 1-2분)
   - "AI 모델이 조직 이미지를 분석하고 있습니다..."
8. 결과 확인:
   ┌─────────────────────────────────┐
   │ 🧠 AI 분석 결과                 │
   ├─────────────────────────────────┤
   │ 분류 결과: 🔴 종양              │
   │ 신뢰도: 92.3%                   │
   │                                 │
   │ 클래스별 확률:                  │
   │ ┌─ 정상    7.7%  ░░░░░░░░      │
   │ └─ 종양   92.3%  ████████████   │
   │                                 │
   │ 분석 패치 수: 856개             │
   │ 주요 관심 영역: 123, 456, ...   │
   └─────────────────────────────────┘
9. 판독 소견 작성
```

---

## 🔧 기술 스택

### 백엔드
- **Django 4.2**: REST API 프레임워크
- **Django REST Framework**: API 개발
- **PyDICOM**: DICOM 파일 처리
- **OpenSlide**: WSI 파일 읽기
- **Requests**: HTTP 클라이언트

### AI/ML
- **Mosec**: 딥러닝 서빙 프레임워크
- **PyTorch**: 딥러닝 프레임워크
- **timm**: H-optimus-0 모델 로드
- **CLAM**: Attention MIL 모델
- **NumPy, PIL**: 이미지 처리

### 프론트엔드
- **React 18**: UI 프레임워크
- **TypeScript**: 타입 안전성
- **Vite**: 빌드 도구
- **Tailwind CSS**: 스타일링
- **Shadcn/ui**: UI 컴포넌트

### 인프라
- **GCP Compute Engine**: VM 호스팅
- **Nginx**: 웹 서버 / 리버스 프록시
- **Gunicorn**: WSGI 서버
- **Systemd**: 서비스 관리
- **Orthanc**: PACS 서버
- **GitHub Actions**: CI/CD

---

## 📈 시스템 모니터링

### 서비스 상태 확인
```bash
# Django 서비스
sudo systemctl status gunicorn

# 병리 AI 서비스
sudo systemctl status pathology-mosec

# Orthanc PACS
sudo systemctl status orthanc

# Nginx
sudo systemctl status nginx
```

### 로그 확인
```bash
# Django 로그
sudo journalctl -u gunicorn -f

# 병리 AI 로그
sudo journalctl -u pathology-mosec -f

# Nginx 로그
sudo tail -f /var/log/nginx/access.log
sudo tail -f /var/log/nginx/error.log
```

### 리소스 사용량
```bash
# 메모리 사용량
free -h

# 디스크 사용량
df -h

# 프로세스 모니터링
htop

# 병리 Mosec 프로세스
ps aux | grep pathology_mosec
```

---

## 🎓 참고 자료

### CLAM 논문
- **제목**: Data-efficient and weakly supervised computational pathology on whole-slide images
- **저자**: Lu et al.
- **학회**: Nature Biomedical Engineering (2021)
- **링크**: https://www.nature.com/articles/s41551-020-00682-w

### H-optimus-0
- **제공**: Bioptimus
- **모델**: Vision Transformer 기반
- **특징**: 병리 이미지 특화 사전학습 모델
- **링크**: https://huggingface.co/bioptimus/H-optimus-0

### 데이터셋
- **TCGA-BRCA**: The Cancer Genome Atlas - Breast Cancer
- **클래스**: Normal vs Tumor
- **이미지 형식**: SVS (Aperio)
- **링크**: https://portal.gdc.cancer.gov/

---

## 🐛 트러블슈팅

### 문제 1: 병리 이미지가 흑백으로 표시됨
**원인**: SVS → DICOM 변환 시 RGB를 Grayscale로 변환  
**해결**: `PhotometricInterpretation`을 'RGB'로 변경, `SamplesPerPixel=3` 설정

### 문제 2: 환자 이름이 표시되지 않음
**원인**: 프론트엔드에서 `patient_name`을 전달하지 않음  
**해결**: `systemPatients`에서 이름을 찾아 FormData에 추가

### 문제 3: AI 분석 시 타임아웃
**원인**: WSI 파일이 크고 패치 추출/Feature 추출에 시간 소요  
**해결**: 타임아웃을 300초(5분)로 설정, 패치 개수 제한(1000개)

### 문제 4: Mosec 서비스 시작 실패
**원인**: 모델 파일 경로 오류 또는 의존성 미설치  
**해결**: 
```bash
# 모델 경로 확인
ls -lh /home/shrjsdn908/pathology_model/best_clam_model.pth

# 의존성 설치
pip install openslide-python timm torch torchvision

# 서비스 재시작
sudo systemctl restart pathology-mosec
```

---

## 📞 문의 및 지원

### 시스템 관리자
- 서버 관리: GCP VM 인스턴스 (34.42.223.43)
- 서비스 재시작: `sudo systemctl restart pathology-mosec`
- 로그 확인: `sudo journalctl -u pathology-mosec -f`

### 개발자
- 백엔드: Django REST API (`pathology_views.py`, `pathology_upload_views.py`)
- AI 모델: Mosec 서비스 (`pathology_mosec.py`)
- 프론트엔드: React 애플리케이션 (`MRIImageDetail.tsx`, `MRIViewer.tsx`)

---

**작성일**: 2026-01-12  
**버전**: 2.0  
**상태**: 운영 중 ✅  
**최근 업데이트**: 
- 2026-01-12: RGB 컬러 이미지 지원 추가
- 2026-01-12: 환자 이름 표시 수정
- 2026-01-12: AI 분석 기능 추가 (MRI/맘모그래피와 동일한 방식)

