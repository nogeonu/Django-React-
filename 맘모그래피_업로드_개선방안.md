# ë§˜ëª¨ê·¸ë˜í”¼ ì—…ë¡œë“œ ì‹œìŠ¤í…œ ê°œì„  ë°©ì•ˆ

## í˜„ì¬ ë¬¸ì œì 

### ê¸°ì¡´ ì‹œìŠ¤í…œ
- âŒ **íŒŒì¼ ë‹¨ìœ„ ì—…ë¡œë“œ**: í•œ ë²ˆì— 1ê°œ íŒŒì¼ë§Œ ì—…ë¡œë“œ
- âŒ **4ë²ˆ ë°˜ë³µ ì‘ì—…**: í•œ í™˜ìì˜ ë§˜ëª¨ê·¸ë˜í”¼ë¥¼ ì—…ë¡œë“œí•˜ë ¤ë©´ 4ë²ˆ í´ë¦­ í•„ìš”
- âŒ **ë·° ì •ë³´ ëˆ„ë½**: L-CC, L-MLO, R-CC, R-MLO êµ¬ë¶„ì´ ìˆ˜ë™
- âŒ **ì—…ë¡œë“œ ì‹œê°„**: 4ì¥ Ã— ì—…ë¡œë“œ ì‹œê°„ = ë¹„íš¨ìœ¨ì 

### VinDr-Mammo ë°ì´í„°ì…‹ êµ¬ì¡°
```
00a7a306c763ab5f0cb6a846825b7d04/  (í™˜ì í´ë”)
â”œâ”€â”€ 274942d5c9036c89aca0b16a36d2b076.dicom  (L-CC)
â”œâ”€â”€ 2ce50597d3a7711d30b9ec3a0aa25623.dicom  (L-MLO)
â”œâ”€â”€ 6c4c8ea04f9fd60b26e6480d988c1e58.dicom  (R-CC)
â””â”€â”€ c7ae763953bfd86e922d9259e2c7afc7.dicom  (R-MLO)
```

## í•´ê²° ë°©ì•ˆ

### ì˜µì…˜ 1: í´ë” ì—…ë¡œë“œ (ì¶”ì²œ â­)

#### ì¥ì 
- âœ… **í•œ ë²ˆì— 4ì¥ ì—…ë¡œë“œ**: í´ë” ì„ íƒ â†’ ìë™ ì—…ë¡œë“œ
- âœ… **ë·° ì •ë³´ ìë™ ì¶”ì¶œ**: DICOM ë©”íƒ€ë°ì´í„°ì—ì„œ ViewPosition ìë™ íŒŒì‹±
- âœ… **í™˜ì ë‹¨ìœ„ ê´€ë¦¬**: í´ë”ëª… = í™˜ì IDë¡œ ìë™ ë§¤í•‘
- âœ… **ì¼ê´„ ì²˜ë¦¬**: 4ì¥ì„ í•˜ë‚˜ì˜ Studyë¡œ ë¬¶ì–´ì„œ ê´€ë¦¬

#### êµ¬í˜„ ë°©ë²•

##### 1. ë°±ì—”ë“œ API ìˆ˜ì •

```python
# orthanc_views.py

@api_view(['POST'])
@parser_classes([MultiPartParser])
def orthanc_upload_dicom_folder(request):
    """
    ë§˜ëª¨ê·¸ë˜í”¼ í´ë” ì—…ë¡œë“œ (í•œ í™˜ìì˜ 4ì¥ ì´ë¯¸ì§€)
    
    POST /api/mri/orthanc/upload-folder/
    Body (multipart/form-data):
        - files[]: ì—¬ëŸ¬ DICOM íŒŒì¼ (4ì¥)
        - patient_id: í™˜ì ID
        - study_description: ê²€ì‚¬ ì„¤ëª… (ì˜ˆ: "Mammography Screening")
    """
    try:
        files = request.FILES.getlist('files')
        patient_id = request.data.get('patient_id')
        study_description = request.data.get('study_description', 'Mammography')
        
        if not files:
            return Response({
                'success': False,
                'error': 'íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.'
            }, status=status.HTTP_400_BAD_REQUEST)
        
        if len(files) != 4:
            return Response({
                'success': False,
                'error': f'ë§˜ëª¨ê·¸ë˜í”¼ëŠ” 4ì¥ì˜ ì´ë¯¸ì§€ê°€ í•„ìš”í•©ë‹ˆë‹¤. (í˜„ì¬: {len(files)}ì¥)'
            }, status=status.HTTP_400_BAD_REQUEST)
        
        client = OrthancClient()
        uploaded_instances = []
        view_positions = []
        
        # ê° íŒŒì¼ ì—…ë¡œë“œ ë° ë·° ì •ë³´ ì¶”ì¶œ
        for file in files:
            file_data = file.read()
            
            # Orthancì— ì—…ë¡œë“œ
            result = client.upload_dicom(file_data)
            instance_id = result['ID']
            uploaded_instances.append(instance_id)
            
            # ë·° ì •ë³´ ì¶”ì¶œ
            instance_info = client.get_instance_info(instance_id)
            view_position = instance_info.get('MainDicomTags', {}).get('ViewPosition', 'Unknown')
            image_laterality = instance_info.get('MainDicomTags', {}).get('ImageLaterality', 'Unknown')
            
            view_positions.append(f"{image_laterality}-{view_position}")
        
        # 4ê°œ ë·°ê°€ ëª¨ë‘ ìˆëŠ”ì§€ í™•ì¸
        expected_views = {'L-CC', 'L-MLO', 'R-CC', 'R-MLO'}
        actual_views = set(view_positions)
        
        if not expected_views.issubset(actual_views):
            missing_views = expected_views - actual_views
            logger.warning(f"ì¼ë¶€ ë·°ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤: {missing_views}")
        
        return Response({
            'success': True,
            'uploaded_count': len(uploaded_instances),
            'instances': uploaded_instances,
            'views': view_positions,
            'patient_id': patient_id,
            'study_description': study_description
        })
        
    except Exception as e:
        logger.error(f"í´ë” ì—…ë¡œë“œ ì‹¤íŒ¨: {str(e)}", exc_info=True)
        return Response({
            'success': False,
            'error': str(e)
        }, status=status.HTTP_500_INTERNAL_SERVER_ERROR)
```

##### 2. í”„ë¡ íŠ¸ì—”ë“œ UI

```typescript
// MammographyUpload.tsx

import React, { useState } from 'react';
import { Upload, FolderOpen, CheckCircle } from 'lucide-react';

interface MammographyUploadProps {
  patientId: string;
}

export const MammographyUpload: React.FC<MammographyUploadProps> = ({ patientId }) => {
  const [files, setFiles] = useState<File[]>([]);
  const [uploading, setUploading] = useState(false);
  const [uploadResult, setUploadResult] = useState<any>(null);

  const handleFolderSelect = (event: React.ChangeEvent<HTMLInputElement>) => {
    const selectedFiles = Array.from(event.target.files || []);
    
    // DICOM íŒŒì¼ë§Œ í•„í„°ë§
    const dicomFiles = selectedFiles.filter(file => 
      file.name.toLowerCase().endsWith('.dicom') || 
      file.name.toLowerCase().endsWith('.dcm')
    );
    
    setFiles(dicomFiles);
  };

  const handleUpload = async () => {
    if (files.length !== 4) {
      alert('ë§˜ëª¨ê·¸ë˜í”¼ëŠ” ì •í™•íˆ 4ì¥ì˜ ì´ë¯¸ì§€ê°€ í•„ìš”í•©ë‹ˆë‹¤.');
      return;
    }

    setUploading(true);
    
    const formData = new FormData();
    files.forEach(file => {
      formData.append('files', file);
    });
    formData.append('patient_id', patientId);
    formData.append('study_description', 'Mammography Screening');

    try {
      const response = await fetch('/api/mri/orthanc/upload-folder/', {
        method: 'POST',
        body: formData,
      });

      const result = await response.json();
      
      if (result.success) {
        setUploadResult(result);
        alert(`ì—…ë¡œë“œ ì™„ë£Œ: ${result.uploaded_count}ì¥`);
      } else {
        alert(`ì—…ë¡œë“œ ì‹¤íŒ¨: ${result.error}`);
      }
    } catch (error) {
      console.error('ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
      alert('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    } finally {
      setUploading(false);
    }
  };

  return (
    <div className="p-6 bg-white rounded-lg shadow">
      <h2 className="text-2xl font-bold mb-4">ë§˜ëª¨ê·¸ë˜í”¼ ì—…ë¡œë“œ</h2>
      
      {/* í´ë” ì„ íƒ */}
      <div className="mb-4">
        <label className="flex items-center gap-2 px-4 py-2 bg-blue-500 text-white rounded cursor-pointer hover:bg-blue-600">
          <FolderOpen size={20} />
          <span>í´ë” ì„ íƒ (4ì¥ ì´ë¯¸ì§€)</span>
          <input
            type="file"
            multiple
            webkitdirectory=""
            directory=""
            onChange={handleFolderSelect}
            className="hidden"
          />
        </label>
      </div>

      {/* ì„ íƒëœ íŒŒì¼ ëª©ë¡ */}
      {files.length > 0 && (
        <div className="mb-4">
          <h3 className="font-semibold mb-2">ì„ íƒëœ íŒŒì¼ ({files.length}/4)</h3>
          <ul className="space-y-1">
            {files.map((file, index) => (
              <li key={index} className="flex items-center gap-2 text-sm">
                <CheckCircle size={16} className="text-green-500" />
                {file.name}
              </li>
            ))}
          </ul>
        </div>
      )}

      {/* ì—…ë¡œë“œ ë²„íŠ¼ */}
      <button
        onClick={handleUpload}
        disabled={files.length !== 4 || uploading}
        className={`flex items-center gap-2 px-6 py-3 rounded font-semibold ${
          files.length === 4 && !uploading
            ? 'bg-green-500 text-white hover:bg-green-600'
            : 'bg-gray-300 text-gray-500 cursor-not-allowed'
        }`}
      >
        <Upload size={20} />
        {uploading ? 'ì—…ë¡œë“œ ì¤‘...' : 'ì—…ë¡œë“œ'}
      </button>

      {/* ì—…ë¡œë“œ ê²°ê³¼ */}
      {uploadResult && (
        <div className="mt-4 p-4 bg-green-50 border border-green-200 rounded">
          <h3 className="font-semibold text-green-800 mb-2">ì—…ë¡œë“œ ì™„ë£Œ!</h3>
          <ul className="text-sm space-y-1">
            <li>ì—…ë¡œë“œëœ ì´ë¯¸ì§€: {uploadResult.uploaded_count}ì¥</li>
            <li>ë·°: {uploadResult.views.join(', ')}</li>
          </ul>
        </div>
      )}
    </div>
  );
};
```

### ì˜µì…˜ 2: ë“œë˜ê·¸ ì•¤ ë“œë¡­ (ëŒ€ì•ˆ)

#### UI ì˜ˆì‹œ
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ë§˜ëª¨ê·¸ë˜í”¼ ì—…ë¡œë“œ                               â”‚
â”‚                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                           â”‚  â”‚
â”‚  â”‚     ğŸ“ ì—¬ê¸°ì— 4ì¥ì˜ ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ì„¸ìš” â”‚  â”‚
â”‚  â”‚                                           â”‚  â”‚
â”‚  â”‚     ë˜ëŠ” í´ë¦­í•˜ì—¬ íŒŒì¼ ì„ íƒ               â”‚  â”‚
â”‚  â”‚                                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                  â”‚
â”‚  í•„ìš”í•œ ë·°:                                      â”‚
â”‚  â˜ L-CC   â˜ L-MLO   â˜ R-CC   â˜ R-MLO          â”‚
â”‚                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ì˜µì…˜ 3: ZIP íŒŒì¼ ì—…ë¡œë“œ

#### ì¥ì 
- ë„¤íŠ¸ì›Œí¬ ì „ì†¡ íš¨ìœ¨ì  (ì••ì¶•)
- í´ë” êµ¬ì¡° ìœ ì§€
- ëŒ€ìš©ëŸ‰ íŒŒì¼ ì²˜ë¦¬ ìš©ì´

#### ë°±ì—”ë“œ êµ¬í˜„
```python
import zipfile
import io

@api_view(['POST'])
def orthanc_upload_zip(request):
    """
    ZIP íŒŒì¼ë¡œ ë§˜ëª¨ê·¸ë˜í”¼ ì—…ë¡œë“œ
    
    POST /api/mri/orthanc/upload-zip/
    Body:
        - zip_file: ZIP íŒŒì¼ (4ê°œ DICOM í¬í•¨)
        - patient_id: í™˜ì ID
    """
    try:
        zip_file = request.FILES['zip_file']
        patient_id = request.data.get('patient_id')
        
        # ZIP íŒŒì¼ ì½ê¸°
        zip_data = zip_file.read()
        zip_buffer = io.BytesIO(zip_data)
        
        uploaded_instances = []
        
        with zipfile.ZipFile(zip_buffer, 'r') as zip_ref:
            # ZIP ë‚´ ëª¨ë“  íŒŒì¼ ì¶”ì¶œ
            for file_name in zip_ref.namelist():
                if file_name.lower().endswith(('.dicom', '.dcm')):
                    file_data = zip_ref.read(file_name)
                    
                    # Orthancì— ì—…ë¡œë“œ
                    client = OrthancClient()
                    result = client.upload_dicom(file_data)
                    uploaded_instances.append(result['ID'])
        
        return Response({
            'success': True,
            'uploaded_count': len(uploaded_instances),
            'instances': uploaded_instances
        })
        
    except Exception as e:
        return Response({
            'success': False,
            'error': str(e)
        }, status=status.HTTP_500_INTERNAL_SERVER_ERROR)
```

## ì¶”ì²œ êµ¬í˜„ ìˆœì„œ

### Phase 1: í´ë” ì—…ë¡œë“œ (í•„ìˆ˜)
1. âœ… ë°±ì—”ë“œ API êµ¬í˜„ (`/api/mri/orthanc/upload-folder/`)
2. âœ… í”„ë¡ íŠ¸ì—”ë“œ í´ë” ì„ íƒ UI
3. âœ… 4ì¥ ê²€ì¦ ë¡œì§
4. âœ… ë·° ì •ë³´ ìë™ ì¶”ì¶œ

### Phase 2: ë“œë˜ê·¸ ì•¤ ë“œë¡­ (ê¶Œì¥)
5. ğŸ“¦ ë“œë˜ê·¸ ì•¤ ë“œë¡­ UI
6. ğŸ“¦ íŒŒì¼ ë¯¸ë¦¬ë³´ê¸°
7. ğŸ“¦ ì§„í–‰ ìƒíƒœ í‘œì‹œ

### Phase 3: ê³ ê¸‰ ê¸°ëŠ¥ (ì„ íƒ)
8. ğŸ”„ ZIP íŒŒì¼ ì§€ì›
9. ğŸ”„ ë°°ì¹˜ ì—…ë¡œë“œ (ì—¬ëŸ¬ í™˜ì)
10. ğŸ”„ ìë™ ë·° ë§¤ì¹­

## ë¹„êµí‘œ

| ê¸°ëŠ¥ | í˜„ì¬ (ë‹¨ì¼ íŒŒì¼) | í´ë” ì—…ë¡œë“œ | ZIP ì—…ë¡œë“œ |
|------|------------------|-------------|------------|
| í´ë¦­ íšŸìˆ˜ | 4ë²ˆ | 1ë²ˆ | 1ë²ˆ |
| ì—…ë¡œë“œ ì‹œê°„ | ëŠë¦¼ (4íšŒ) | ë¹ ë¦„ (1íšŒ) | ê°€ì¥ ë¹ ë¦„ |
| ë·° êµ¬ë¶„ | ìˆ˜ë™ | ìë™ | ìë™ |
| ë„¤íŠ¸ì›Œí¬ íš¨ìœ¨ | ë‚®ìŒ | ì¤‘ê°„ | ë†’ìŒ (ì••ì¶•) |
| êµ¬í˜„ ë‚œì´ë„ | ì‰¬ì›€ | ì¤‘ê°„ | ì¤‘ê°„ |
| ì‚¬ìš©ì í¸ì˜ì„± | â­â­ | â­â­â­â­ | â­â­â­â­â­ |

## ê²°ë¡ 

**ì¶”ì²œ: í´ë” ì—…ë¡œë“œ (ì˜µì…˜ 1)**

ì´ìœ :
1. âœ… ì‚¬ìš©ì ê²½í—˜ ëŒ€í­ ê°œì„  (4ë²ˆ â†’ 1ë²ˆ í´ë¦­)
2. âœ… ë·° ì •ë³´ ìë™ ì¶”ì¶œë¡œ ì˜¤ë¥˜ ê°ì†Œ
3. âœ… í™˜ì ë‹¨ìœ„ ê´€ë¦¬ ìš©ì´
4. âœ… êµ¬í˜„ ë‚œì´ë„ ì ì ˆ
5. âœ… ì¶”í›„ ZIP ì—…ë¡œë“œë¡œ í™•ì¥ ê°€ëŠ¥

**êµ¬í˜„ ìš°ì„ ìˆœìœ„**:
1. í´ë” ì—…ë¡œë“œ API (ë°±ì—”ë“œ)
2. í´ë” ì„ íƒ UI (í”„ë¡ íŠ¸ì—”ë“œ)
3. ë·° ê²€ì¦ ë¡œì§
4. (ì„ íƒ) ë“œë˜ê·¸ ì•¤ ë“œë¡­
5. (ì„ íƒ) ZIP ì§€ì›

