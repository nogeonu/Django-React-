name: Deploy to GCE VM

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Clean remote directory and fix permissions
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          timeout: 300s
          command_timeout: 300s
          debug: true
          script: |
            set -e
            APP_DIR="${{ secrets.APP_DIR }}"
            
            # 권한 정리 (staticfiles, __pycache__ 등)
            sudo chown -R $USER:$USER "$APP_DIR" || true
            sudo rm -rf "$APP_DIR/backend/staticfiles" || true
            find "$APP_DIR/backend" -type d -name "__pycache__" -exec sudo rm -rf {} + || true
            find "$APP_DIR/backend" -type f -name "*.pyc" -delete || true

            # frontend 캐시 완전 삭제 (중복 파일 제거)
            sudo rm -rf "$APP_DIR/frontend/node_modules" || true
            sudo rm -rf "$APP_DIR/frontend/dist" || true
            find "$APP_DIR/frontend/src/pages" -name "* 2.*" -type f -delete || true
            find "$APP_DIR/frontend/src/pages" -name "* 2.tsx" -type f -delete || true

      - name: Sync project to VM (rsync)
        uses: burnett01/rsync-deployments@5.2
        with:
          switches: -avz --exclude ".git" --exclude "node_modules" --exclude ".venv" --exclude "venv" --exclude "frontend/dist" --exclude ".DS_Store" --exclude "backend/staticfiles" --exclude "backend/*.pyc" --exclude "backend/*/__pycache__" --timeout=300
          path: ./
          remote_path: ${{ secrets.APP_DIR }}/
          remote_host: ${{ secrets.SSH_HOST }}
          remote_user: ${{ secrets.SSH_USER }}
          remote_key: ${{ secrets.SSH_KEY }}
          remote_port: ${{ secrets.SSH_PORT }}

      - name: Remote deploy steps
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          timeout: 1800s
          command_timeout: 600s
          debug: true
          script: |
            set -e  # 오류 발생 시 즉시 중단
            APP_DIR="${{ secrets.APP_DIR }}"

            # 권한 수정
            sudo chown -R $USER:$USER "$APP_DIR" || echo "chown failed, continuing..."

            # --- Django backend ---
            cd "$APP_DIR/backend"
            python3 -m venv .venv || true
            source .venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt

            # DB 마이그레이션/정적파일
            set +e  # 마이그레이션 오류 허용
            
            # patients_appointment 테이블이 이미 존재하는 경우 fake migration 적용
            python manage.py migrate patients 0001_appointment --fake 2>/dev/null || true
            
            # 일반 마이그레이션 실행 (이미 적용된 것은 스킵)
            python manage.py migrate 2>&1 | tee /tmp/migrate.log
            MIGRATE_EXIT_CODE=${PIPESTATUS[0]}
            
            if [ $MIGRATE_EXIT_CODE -ne 0 ]; then
              # "already exists" 오류인 경우 fake 처리하고 계속 진행
              if grep -q "already exists" /tmp/migrate.log; then
                echo "Table already exists, marking migrations as applied..."
                python manage.py migrate patients 0001_appointment --fake 2>/dev/null || true
                python manage.py migrate patients --fake 2>/dev/null || true
              else
                echo "Migration failed, attempting to resolve conflicts..."
                python manage.py makemigrations --merge --noinput || true
                python manage.py migrate 2>&1 | grep -v "already exists" || echo "Migration completed with warnings"
              fi
            else
              echo "Migrations completed successfully"
            fi
            
            # collectstatic 실행 전 디렉토리 준비
            mkdir -p "$APP_DIR/backend/staticfiles"
            chmod -R 755 "$APP_DIR/backend/staticfiles" || true
            sudo chown -R $USER:$USER "$APP_DIR/backend/staticfiles" || true
            
            # collectstatic 실행
            python manage.py collectstatic --noinput
            if [ $? -ne 0 ]; then
              echo "collectstatic failed, retrying..."
              mkdir -p "$APP_DIR/backend/staticfiles"
              python manage.py collectstatic --noinput --clear
            fi
            echo "collectstatic completed successfully"

            # --- React frontend ---
            cd "$APP_DIR/frontend"
            
            # Node.js 확인 및 설치
            if ! command -v npm >/dev/null 2>&1; then
              echo "Installing Node.js..."
              curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi
            
            # Node.js 버전 확인
            node --version
            npm --version
            
            # 디렉토리 정리 및 권한 설정
            mkdir -p dist
            chmod -R 755 "$APP_DIR/frontend" || true
            sudo chown -R $USER:$USER "$APP_DIR/frontend" || true
            
            # node_modules, dist 캐시 완전 삭제
            rm -rf node_modules dist .next
            
            # 패키지 설치
            echo "Installing npm packages..."
            npm ci || {
              echo "npm ci failed, trying npm install..."
              rm -rf node_modules package-lock.json
              npm install
            }
            
            # 빌드 실행
            echo "Building frontend..."
            npm run build || {
              echo "First build attempt failed, retrying with clean cache..."
              rm -rf node_modules/.cache dist .next
              npm run build
            }
            echo "Frontend build completed successfully"

            # --- ML Service 설정 및 시작 ---
            # ML Service 파일 생성
            echo '[Unit]' | sudo tee /etc/systemd/system/ml-service.service > /dev/null
            echo 'Description=ML Service (Flask) for Lung Cancer Prediction' | sudo tee -a /etc/systemd/system/ml-service.service
            echo 'After=network.target' | sudo tee -a /etc/systemd/system/ml-service.service
            echo '' | sudo tee -a /etc/systemd/system/ml-service.service
            echo '[Service]' | sudo tee -a /etc/systemd/system/ml-service.service
            echo 'User=shrjsdn908' | sudo tee -a /etc/systemd/system/ml-service.service
            echo 'Group=shrjsdn908' | sudo tee -a /etc/systemd/system/ml-service.service
            echo 'WorkingDirectory=/srv/django-react/app/backend' | sudo tee -a /etc/systemd/system/ml-service.service
            echo 'Environment=PATH=/srv/django-react/app/backend/.venv/bin' | sudo tee -a /etc/systemd/system/ml-service.service
            echo 'ExecStart=/srv/django-react/app/backend/.venv/bin/gunicorn --workers 2 --bind 127.0.0.1:5002 ml_service.app:app' | sudo tee -a /etc/systemd/system/ml-service.service
            echo 'Restart=always' | sudo tee -a /etc/systemd/system/ml-service.service
            echo '' | sudo tee -a /etc/systemd/system/ml-service.service
            echo '[Install]' | sudo tee -a /etc/systemd/system/ml-service.service
            echo 'WantedBy=multi-user.target' | sudo tee -a /etc/systemd/system/ml-service.service

            # --- 서비스 재시작 ---
            # Gunicorn 서비스 파일 업데이트 (eventeye 사용하도록)
            echo '[Unit]' | sudo tee /etc/systemd/system/gunicorn.service
            echo 'Description=Gunicorn for Django' | sudo tee -a /etc/systemd/system/gunicorn.service
            echo 'After=network.target' | sudo tee -a /etc/systemd/system/gunicorn.service
            echo '' | sudo tee -a /etc/systemd/system/gunicorn.service
            echo '[Service]' | sudo tee -a /etc/systemd/system/gunicorn.service
            echo 'User=shrjsdn908' | sudo tee -a /etc/systemd/system/gunicorn.service
            echo 'Group=shrjsdn908' | sudo tee -a /etc/systemd/system/gunicorn.service
            echo 'WorkingDirectory=/srv/django-react/app/backend' | sudo tee -a /etc/systemd/system/gunicorn.service
            echo 'Environment=PATH=/srv/django-react/app/backend/.venv/bin' | sudo tee -a /etc/systemd/system/gunicorn.service
            echo 'ExecStart=/srv/django-react/app/backend/.venv/bin/gunicorn eventeye.wsgi:application --bind 127.0.0.1:8000 --workers 3' | sudo tee -a /etc/systemd/system/gunicorn.service
            echo 'Restart=always' | sudo tee -a /etc/systemd/system/gunicorn.service
            echo '' | sudo tee -a /etc/systemd/system/gunicorn.service
            echo '[Install]' | sudo tee -a /etc/systemd/system/gunicorn.service
            echo 'WantedBy=multi-user.target' | sudo tee -a /etc/systemd/system/gunicorn.service
            # systemd 데몬 리로드
            sudo systemctl daemon-reload
            
            # ML Service 재시작
            if sudo systemctl is-active --quiet ml-service; then
              sudo systemctl restart ml-service
            else
              sudo systemctl enable ml-service
              sudo systemctl start ml-service
            fi
            sleep 3
            sudo systemctl status ml-service --no-pager || echo "ML service status check completed"
            
            # Gunicorn 재시작
            if sudo systemctl is-active --quiet gunicorn; then
              sudo systemctl restart gunicorn
            else
              sudo systemctl enable gunicorn
              sudo systemctl start gunicorn
            fi
            echo "Services restarted successfully"
            
            # Nginx 설정에 미디어 파일 서빙 추가
            # 미디어 디렉토리 생성
            mkdir -p "$APP_DIR/backend/media"
            chmod -R 755 "$APP_DIR/backend/media" || true
            sudo chown -R $USER:$USER "$APP_DIR/backend/media" || true
            
            # Nginx 설정 파일 생성
            echo 'server {' | sudo tee /etc/nginx/sites-available/eventeye > /dev/null
            echo '    listen 80;' | sudo tee -a /etc/nginx/sites-available/eventeye
            echo '    server_name 34.42.223.43;' | sudo tee -a /etc/nginx/sites-available/eventeye
            echo '    ' | sudo tee -a /etc/nginx/sites-available/eventeye
            echo '    client_max_body_size 100M;' | sudo tee -a /etc/nginx/sites-available/eventeye
            echo '    ' | sudo tee -a /etc/nginx/sites-available/eventeye
            echo '    location /static/ {' | sudo tee -a /etc/nginx/sites-available/eventeye
            echo '        alias /srv/django-react/app/backend/staticfiles/;' | sudo tee -a /etc/nginx/sites-available/eventeye
            echo '    }' | sudo tee -a /etc/nginx/sites-available/eventeye
            echo '    ' | sudo tee -a /etc/nginx/sites-available/eventeye
            echo '    location /media/ {' | sudo tee -a /etc/nginx/sites-available/eventeye
            echo '        alias /srv/django-react/app/backend/media/;' | sudo tee -a /etc/nginx/sites-available/eventeye
            echo '    }' | sudo tee -a /etc/nginx/sites-available/eventeye
            echo '    ' | sudo tee -a /etc/nginx/sites-available/eventeye
            echo '    location / {' | sudo tee -a /etc/nginx/sites-available/eventeye
            echo '        proxy_pass http://127.0.0.1:8000;' | sudo tee -a /etc/nginx/sites-available/eventeye
            echo '        proxy_set_header Host $host;' | sudo tee -a /etc/nginx/sites-available/eventeye
            echo '        proxy_set_header X-Real-IP $remote_addr;' | sudo tee -a /etc/nginx/sites-available/eventeye
            echo '        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;' | sudo tee -a /etc/nginx/sites-available/eventeye
            echo '        proxy_set_header X-Forwarded-Proto $scheme;' | sudo tee -a /etc/nginx/sites-available/eventeye
            echo '    }' | sudo tee -a /etc/nginx/sites-available/eventeye
            echo '}' | sudo tee -a /etc/nginx/sites-available/eventeye
            
            # Nginx 설정 활성화
            sudo ln -sf /etc/nginx/sites-available/eventeye /etc/nginx/sites-enabled/
            
            # Nginx 설정 테스트
            sudo nginx -t || {
              echo "Nginx configuration test failed"
              exit 1
            }
            
            # Nginx 재시작
            if sudo systemctl is-active --quiet nginx; then
              sudo systemctl reload nginx
            else
              sudo systemctl start nginx
            fi
            echo "Nginx configuration applied successfully"
            echo "Deployment completed successfully!"

