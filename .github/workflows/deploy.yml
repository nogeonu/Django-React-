name: Deploy to GCE VM

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Clean remote directory and fix permissions
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script: |
            set -e
            APP_DIR="${{ secrets.APP_DIR }}"
            
            # 권한 정리 (staticfiles, __pycache__ 등)
            sudo chown -R $USER:$USER "$APP_DIR" || true
            sudo rm -rf "$APP_DIR/backend/staticfiles" || true
            find "$APP_DIR/backend" -type d -name "__pycache__" -exec sudo rm -rf {} + || true
            find "$APP_DIR/backend" -type f -name "*.pyc" -delete || true

            # frontend 캐시 완전 삭제 (중복 파일 제거)
            sudo rm -rf "$APP_DIR/frontend/node_modules" || true
            sudo rm -rf "$APP_DIR/frontend/dist" || true
            find "$APP_DIR/frontend/src/pages" -name "* 2.*" -type f -delete || true
            find "$APP_DIR/frontend/src/pages" -name "* 2.tsx" -type f -delete || true

      - name: Sync project to VM (rsync)
        uses: burnett01/rsync-deployments@5.2
        with:
          switches: -avz --exclude ".git" --exclude "node_modules" --exclude ".venv" --exclude "venv" --exclude "frontend/dist" --exclude ".DS_Store" --exclude "backend/staticfiles" --exclude "backend/*.pyc" --exclude "backend/*/__pycache__"
          path: ./
          remote_path: ${{ secrets.APP_DIR }}/
          remote_host: ${{ secrets.SSH_HOST }}
          remote_user: ${{ secrets.SSH_USER }}
          remote_key: ${{ secrets.SSH_KEY }}
          remote_port: ${{ secrets.SSH_PORT }}

      - name: Remote deploy steps
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script_stop: true
          script: |
            set -e
            APP_DIR="${{ secrets.APP_DIR }}"

            # 권한 수정
            sudo chown -R $USER:$USER "$APP_DIR"

            # --- Django backend ---
            cd "$APP_DIR/backend"
            python3 -m venv .venv || true
            source .venv/bin/activate
            pip install --upgrade pip
            pip install -r requirements.txt

            # DB 마이그레이션/정적파일
            set +e  # 마이그레이션 오류 허용
            
            # patients_appointment 테이블이 이미 존재하는 경우 fake migration 적용
            python manage.py migrate patients 0001_appointment --fake 2>/dev/null || true
            
            # 일반 마이그레이션 실행 (이미 적용된 것은 스킵)
            python manage.py migrate 2>&1 | tee /tmp/migrate.log
            MIGRATE_EXIT_CODE=${PIPESTATUS[0]}
            
            if [ $MIGRATE_EXIT_CODE -ne 0 ]; then
              # "already exists" 오류인 경우 fake 처리하고 계속 진행
              if grep -q "already exists" /tmp/migrate.log; then
                echo "Table already exists, marking migrations as applied..."
                python manage.py migrate patients 0001_appointment --fake 2>/dev/null || true
                python manage.py migrate patients --fake 2>/dev/null || true
              else
                echo "Migration failed, attempting to resolve conflicts..."
                python manage.py makemigrations --merge --noinput || true
                python manage.py migrate 2>&1 | grep -v "already exists" || echo "Migration completed with warnings"
              fi
            else
              echo "Migrations completed successfully"
            fi
            
            # collectstatic 실행 (오류가 있어도 계속 진행)
            set +e
            python manage.py collectstatic --noinput
            COLLECTSTATIC_EXIT_CODE=$?
            if [ $COLLECTSTATIC_EXIT_CODE -ne 0 ]; then
              echo "collectstatic failed with exit code $COLLECTSTATIC_EXIT_CODE, but continuing..."
            fi
            set -e  # 다시 오류 시 중단 활성화

            # --- React frontend ---
            cd "$APP_DIR/frontend"
            set +e  # 프론트엔드 빌드 오류 허용 (일시적)
            if ! command -v npm >/dev/null 2>&1; then
              curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi
            # node_modules, dist 캐시 완전 삭제
            rm -rf node_modules dist .next
            npm ci
            BUILD_EXIT_CODE=$?
            if [ $BUILD_EXIT_CODE -ne 0 ]; then
              echo "npm ci failed, trying npm install..."
              npm install
            fi
            npm run build
            BUILD_EXIT_CODE=$?
            set -e  # 다시 오류 시 중단 활성화
            if [ $BUILD_EXIT_CODE -ne 0 ]; then
              echo "Frontend build failed with exit code $BUILD_EXIT_CODE"
              echo "Checking for TypeScript errors..."
              npm run build 2>&1 | head -50 || true
              echo "Continuing deployment despite build errors..."
            fi

            # --- ML Service 설정 및 시작 ---
            echo '[Unit]' | sudo tee /etc/systemd/system/ml-service.service
            echo 'Description=ML Service (Flask) for Lung Cancer Prediction' | sudo tee -a /etc/systemd/system/ml-service.service
            echo 'After=network.target' | sudo tee -a /etc/systemd/system/ml-service.service
            echo '' | sudo tee -a /etc/systemd/system/ml-service.service
            echo '[Service]' | sudo tee -a /etc/systemd/system/ml-service.service
            echo 'User=shrjsdn908' | sudo tee -a /etc/systemd/system/ml-service.service
            echo 'Group=shrjsdn908' | sudo tee -a /etc/systemd/system/ml-service.service
            echo 'WorkingDirectory=/srv/django-react/app/backend' | sudo tee -a /etc/systemd/system/ml-service.service
            echo 'Environment=PATH=/srv/django-react/app/backend/.venv/bin' | sudo tee -a /etc/systemd/system/ml-service.service
            echo 'ExecStart=/srv/django-react/app/backend/.venv/bin/gunicorn --workers 2 --bind 127.0.0.1:5002 ml_service.app:app' | sudo tee -a /etc/systemd/system/ml-service.service
            echo 'Restart=always' | sudo tee -a /etc/systemd/system/ml-service.service
            echo '' | sudo tee -a /etc/systemd/system/ml-service.service
            echo '[Install]' | sudo tee -a /etc/systemd/system/ml-service.service
            echo 'WantedBy=multi-user.target' | sudo tee -a /etc/systemd/system/ml-service.service

            # --- 서비스 재시작 ---
            # Gunicorn 서비스 파일 업데이트 (eventeye 사용하도록)
            echo '[Unit]' | sudo tee /etc/systemd/system/gunicorn.service
            echo 'Description=Gunicorn for Django' | sudo tee -a /etc/systemd/system/gunicorn.service
            echo 'After=network.target' | sudo tee -a /etc/systemd/system/gunicorn.service
            echo '' | sudo tee -a /etc/systemd/system/gunicorn.service
            echo '[Service]' | sudo tee -a /etc/systemd/system/gunicorn.service
            echo 'User=shrjsdn908' | sudo tee -a /etc/systemd/system/gunicorn.service
            echo 'Group=shrjsdn908' | sudo tee -a /etc/systemd/system/gunicorn.service
            echo 'WorkingDirectory=/srv/django-react/app/backend' | sudo tee -a /etc/systemd/system/gunicorn.service
            echo 'Environment=PATH=/srv/django-react/app/backend/.venv/bin' | sudo tee -a /etc/systemd/system/gunicorn.service
            echo 'ExecStart=/srv/django-react/app/backend/.venv/bin/gunicorn eventeye.wsgi:application --bind 127.0.0.1:8000 --workers 3' | sudo tee -a /etc/systemd/system/gunicorn.service
            echo 'Restart=always' | sudo tee -a /etc/systemd/system/gunicorn.service
            echo '' | sudo tee -a /etc/systemd/system/gunicorn.service
            echo '[Install]' | sudo tee -a /etc/systemd/system/gunicorn.service
            echo 'WantedBy=multi-user.target' | sudo tee -a /etc/systemd/system/gunicorn.service
            sudo systemctl daemon-reload || echo "daemon-reload failed, continuing..."
            sudo systemctl restart ml-service || sudo systemctl start ml-service || echo "ml-service failed, continuing..."
            sleep 5
            sudo systemctl status ml-service || true
            sudo systemctl restart gunicorn || sudo systemctl start gunicorn || echo "gunicorn failed, continuing..."
            set -e  # 다시 오류 시 중단 활성화
            
            # Nginx 설정에 미디어 파일 서빙 추가
            set +e  # Nginx 설정 오류 허용
            echo 'server {' | sudo tee /etc/nginx/sites-available/eventeye
            echo '    listen 80;' | sudo tee -a /etc/nginx/sites-available/eventeye
            echo '    server_name 34.42.223.43;' | sudo tee -a /etc/nginx/sites-available/eventeye
            echo '    ' | sudo tee -a /etc/nginx/sites-available/eventeye
            echo '    client_max_body_size 100M;' | sudo tee -a /etc/nginx/sites-available/eventeye
            echo '    ' | sudo tee -a /etc/nginx/sites-available/eventeye
            echo '    location /static/ {' | sudo tee -a /etc/nginx/sites-available/eventeye
            echo '        alias /srv/django-react/app/backend/staticfiles/;' | sudo tee -a /etc/nginx/sites-available/eventeye
            echo '    }' | sudo tee -a /etc/nginx/sites-available/eventeye
            echo '    ' | sudo tee -a /etc/nginx/sites-available/eventeye
            echo '    location /media/ {' | sudo tee -a /etc/nginx/sites-available/eventeye
            echo '        alias /srv/django-react/app/backend/media/;' | sudo tee -a /etc/nginx/sites-available/eventeye
            echo '    }' | sudo tee -a /etc/nginx/sites-available/eventeye
            echo '    ' | sudo tee -a /etc/nginx/sites-available/eventeye
            echo '    location / {' | sudo tee -a /etc/nginx/sites-available/eventeye
            echo '        proxy_pass http://127.0.0.1:8000;' | sudo tee -a /etc/nginx/sites-available/eventeye
            echo '        proxy_set_header Host $host;' | sudo tee -a /etc/nginx/sites-available/eventeye
            echo '        proxy_set_header X-Real-IP $remote_addr;' | sudo tee -a /etc/nginx/sites-available/eventeye
            echo '        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;' | sudo tee -a /etc/nginx/sites-available/eventeye
            echo '        proxy_set_header X-Forwarded-Proto $scheme;' | sudo tee -a /etc/nginx/sites-available/eventeye
            echo '    }' | sudo tee -a /etc/nginx/sites-available/eventeye
            echo '}' | sudo tee -a /etc/nginx/sites-available/eventeye
            
            sudo ln -sf /etc/nginx/sites-available/eventeye /etc/nginx/sites-enabled/ || echo "nginx symlink failed, continuing..."
            sudo nginx -t && sudo systemctl reload nginx || sudo systemctl restart nginx || echo "nginx reload/restart failed, continuing..."
            set -e  # 다시 오류 시 중단 활성화

