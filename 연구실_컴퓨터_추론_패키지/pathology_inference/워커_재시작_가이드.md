# 🔄 워커 재시작 가이드 (RTX 3060 최적화 후)

교육원 PC에서 배치 사이즈와 멀티코어 설정을 최적화한 후 워커를 재시작하는 방법입니다.

## ✅ 최적화 완료 확인

다음 설정이 `run_analysis.py`에 적용되었는지 확인하세요:

- **batch_size**: 8 → **16** (RTX 3060 12GB VRAM 활용)
- **num_workers**: 12 (고정) → **8-16** (자동 조정)
- **prefetch_factor**: 4 → **2** (배치 사이즈 증가로 조정)

## 🔄 워커 재시작 방법

### 방법 1: Windows 배치 파일 사용 (권장)

```bash
# 1. 현재 실행 중인 워커 종료
# 터미널 창에서 Ctrl+C 누르기

# 2. 워커 재시작
start_worker_http.bat
```

### 방법 2: 수동 실행

```bash
# 1. 가상환경 활성화
venv\Scripts\activate

# 2. 워커 실행
python local_inference_worker_http.py
```

### 방법 3: 백그라운드 실행 (Windows)

```bash
# PowerShell에서 실행
Start-Process python -ArgumentList "local_inference_worker_http.py" -WindowStyle Hidden
```

## 📋 재시작 전 확인사항

1. ✅ **환경 변수 확인**
   - `.env` 파일에 `DJANGO_API_URL`이 올바르게 설정되어 있는지 확인
   - `WSI_DIR` 환경 변수가 설정되어 있으면 `wsi/` 폴더 경로 확인

2. ✅ **wsi/ 폴더 확인**
   - `wsi/` 폴더에 다음 파일들이 있는지 확인:
     - `tumor_083.tif`
     - `normal_059.tif`
     - `normal_103.tif`

3. ✅ **GPU 확인**
   - RTX 3060이 정상적으로 인식되는지 확인
   - `nvidia-smi` 명령어로 GPU 상태 확인

## 🚀 재시작 후 확인

워커가 정상적으로 시작되면 다음 메시지가 표시됩니다:

```
============================================================
🚀 병리 이미지 추론 HTTP API 워커 시작
============================================================
🌐 Django API URL: http://34.42.223.43/api/pathology
⏱️ 폴링 간격: 30초
🖥️ 디바이스: cuda
============================================================
✅ 공유 디렉토리 불필요!
✅ 연구실 내부 IP 불필요!
✅ 인터넷 연결만 있으면 됩니다!
============================================================

🔍 Django API 연결 테스트...
✅ Django API 연결 성공! (대기 중인 요청: 0개)

💡 워커가 실행 중입니다. 종료하려면 Ctrl+C를 누르세요.
```

## ⚡ 성능 향상 확인

최적화 후 예상 성능:

- **처리 속도**: 약 2배 향상 (배치 사이즈 2배)
- **전체 소요 시간**: 약 50% 단축
- **예시**: 76,023 패치 기준 약 10-12분 (기존 20-25분)

## 🔧 문제 해결

### 워커가 시작되지 않는 경우

1. **가상환경 확인**
   ```bash
   venv\Scripts\activate
   python --version
   ```

2. **의존성 확인**
   ```bash
   pip install -r requirements.txt
   ```

3. **환경 변수 확인**
   ```bash
   type .env
   ```

### GPU가 인식되지 않는 경우

1. **CUDA 설치 확인**
   ```bash
   python -c "import torch; print(torch.cuda.is_available())"
   ```

2. **GPU 드라이버 확인**
   ```bash
   nvidia-smi
   ```

### 파일을 찾을 수 없는 경우

1. **wsi/ 폴더 경로 확인**
   - 현재 디렉토리에 `wsi/` 폴더가 있는지 확인
   - 또는 `.env` 파일에 `WSI_DIR` 환경 변수 설정

2. **파일명 확인**
   - 프론트엔드에서 보낸 파일명과 실제 파일명이 정확히 일치하는지 확인
   - 대소문자 구분 확인

## 📝 참고

- 워커는 30초마다 Django API를 폴링합니다
- 대기 중인 요청이 있으면 자동으로 처리합니다
- 처리 중인 요청은 중복 할당되지 않습니다
- 결과는 자동으로 Django API로 업로드됩니다
